import axios from 'axios';
import FormData from 'form-data';
import { Readable } from 'stream';

const VIRUSTOTAL_API_KEY = process.env.VIRUSTOTAL_API_KEY || '';
const VIRUSTOTAL_API_URL = 'https://www.virustotal.com/api/v3';

/**
 * Scan result interface
 */
export interface ScanResult {
  isClean: boolean;
  isMalicious: boolean;
  scanId?: string;
  detectionRate?: string;
  engines?: {
    detected: number;
    total: number;
  };
  threats?: string[];
  scanDate?: Date;
  permalink?: string;
}

/**
 * Upload and scan a file with VirusTotal
 * @param fileBuffer - The file buffer to scan
 * @param filename - Original filename
 * @returns Scan result
 */
export const scanFile = async (
  fileBuffer: Buffer,
  filename: string
): Promise<ScanResult> => {
  try {
    if (!VIRUSTOTAL_API_KEY) {
      console.warn('VirusTotal API key not configured, skipping malware scan');
      return {
        isClean: true,
        isMalicious: false,
        scanId: 'no-scan-performed',
      };
    }

    // Create form data
    const formData = new FormData();
    formData.append('file', fileBuffer, {
      filename,
      contentType: 'application/octet-stream',
    });

    // Upload file to VirusTotal
    const uploadResponse = await axios.post(
      `${VIRUSTOTAL_API_URL}/files`,
      formData,
      {
        headers: {
          'x-apikey': VIRUSTOTAL_API_KEY,
          ...formData.getHeaders(),
        },
        maxBodyLength: Infinity,
        maxContentLength: Infinity,
      }
    );

    const analysisId = uploadResponse.data.data.id;
    console.log(`File uploaded to VirusTotal. Analysis ID: ${analysisId}`);

    // Wait a moment for initial scan
    await new Promise((resolve) => setTimeout(resolve, 3000));

    // Get scan results
    const analysisResponse = await axios.get(
      `${VIRUSTOTAL_API_URL}/analyses/${analysisId}`,
      {
        headers: {
          'x-apikey': VIRUSTOTAL_API_KEY,
        },
      }
    );

    const analysis = analysisResponse.data.data.attributes;
    const stats = analysis.stats;

    const detectedEngines = stats.malicious + stats.suspicious;
    const totalEngines = Object.values(stats).reduce((a: any, b: any) => a + b, 0);

    const isMalicious = detectedEngines > 0;
    const threats: string[] = [];

    // Extract threat names if malicious
    if (isMalicious && analysis.results) {
      Object.entries(analysis.results).forEach(([engine, result]: [string, any]) => {
        if (result.category === 'malicious' && result.result) {
          threats.push(`${engine}: ${result.result}`);
        }
      });
    }

    const result: ScanResult = {
      isClean: !isMalicious,
      isMalicious,
      scanId: analysisId,
      detectionRate: `${detectedEngines}/${totalEngines}`,
      engines: {
        detected: detectedEngines,
        total: totalEngines as number,
      },
      threats: threats.length > 0 ? threats : undefined,
      scanDate: new Date(),
      permalink: `https://www.virustotal.com/gui/file-analysis/${analysisId}`,
    };

    console.log(`Malware scan complete: ${result.detectionRate} detections`);

    return result;
  } catch (error: any) {
    console.error('Error scanning file with VirusTotal:', error.message);
    
    // If VirusTotal is unavailable or rate limited, don't fail the upload
    // Log the error and return a warning result
    return {
      isClean: true, // Assume clean if scan fails
      isMalicious: false,
      scanId: 'scan-failed',
    };
  }
};

/**
 * Scan a file by its hash (faster for known files)
 * @param sha256Hash - SHA256 hash of the file
 * @returns Scan result
 */
export const scanByHash = async (sha256Hash: string): Promise<ScanResult> => {
  try {
    if (!VIRUSTOTAL_API_KEY) {
      return {
        isClean: true,
        isMalicious: false,
        scanId: 'no-scan-performed',
      };
    }

    const response = await axios.get(
      `${VIRUSTOTAL_API_URL}/files/${sha256Hash}`,
      {
        headers: {
          'x-apikey': VIRUSTOTAL_API_KEY,
        },
      }
    );

    const attributes = response.data.data.attributes;
    const stats = attributes.last_analysis_stats;

    const detectedEngines = stats.malicious + stats.suspicious;
    const totalEngines = Object.values(stats).reduce((a: any, b: any) => a + b, 0);

    const isMalicious = detectedEngines > 0;

    return {
      isClean: !isMalicious,
      isMalicious,
      scanId: sha256Hash,
      detectionRate: `${detectedEngines}/${totalEngines}`,
      engines: {
        detected: detectedEngines,
        total: totalEngines as number,
      },
      scanDate: new Date(attributes.last_analysis_date * 1000),
      permalink: `https://www.virustotal.com/gui/file/${sha256Hash}`,
    };
  } catch (error: any) {
    if (error.response?.status === 404) {
      // File hash not found in VirusTotal database
      console.log('File hash not found in VirusTotal database, uploading for scan');
      return {
        isClean: true,
        isMalicious: false,
        scanId: 'hash-not-found',
      };
    }

    console.error('Error scanning by hash:', error.message);
    return {
      isClean: true,
      isMalicious: false,
      scanId: 'scan-failed',
    };
  }
};

/**
 * Get detailed scan report
 * @param scanId - The analysis ID or file hash
 * @returns Detailed scan information
 */
export const getScanReport = async (scanId: string): Promise<any> => {
  try {
    if (!VIRUSTOTAL_API_KEY) {
      throw new Error('VirusTotal API key not configured');
    }

    const response = await axios.get(
      `${VIRUSTOTAL_API_URL}/analyses/${scanId}`,
      {
        headers: {
          'x-apikey': VIRUSTOTAL_API_KEY,
        },
      }
    );

    return response.data.data;
  } catch (error) {
    console.error('Error fetching scan report:', error);
    throw new Error('Failed to fetch scan report');
  }
};

/**
 * Check if VirusTotal is configured and available
 */
export const isAvailable = (): boolean => {
  return Boolean(VIRUSTOTAL_API_KEY);
};

/**
 * Quarantine handler for infected files
 * This should be called when a malicious file is detected
 */
export const handleMaliciousFile = async (
  documentId: number,
  scanResult: ScanResult
): Promise<void> => {
  try {
    // Log the malicious file detection
    console.error(`ðŸš¨ MALICIOUS FILE DETECTED - Document ID: ${documentId}`);
    console.error(`Detection Rate: ${scanResult.detectionRate}`);
    console.error(`Threats: ${scanResult.threats?.join(', ')}`);
    console.error(`VirusTotal Report: ${scanResult.permalink}`);

    // In a production system, you would:
    // 1. Mark the document as quarantined in the database
    // 2. Move the file to a quarantine storage location
    // 3. Send alerts to administrators
    // 4. Log to SIEM
    // 5. Potentially notify the uploader

    // For now, we'll log and throw an error
    throw new Error(
      `Malicious file detected: ${scanResult.detectionRate} engines detected threats`
    );
  } catch (error) {
    console.error('Error handling malicious file:', error);
    throw error;
  }
};

export default {
  scanFile,
  scanByHash,
  getScanReport,
  isAvailable,
  handleMaliciousFile,
};
